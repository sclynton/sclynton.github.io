<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€æ•°æ®æ ¼å¼å…¼å®¹æ€§æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f7ff;
        }
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #1976D2;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>è€æ•°æ®æ ¼å¼å…¼å®¹æ€§å…¨é¢æµ‹è¯•</h1>
        <p>æœ¬æµ‹è¯•éªŒè¯æ‰€æœ‰åŠŸèƒ½æ˜¯å¦èƒ½æ­£ç¡®å¤„ç†æ—§ç‰ˆæ•°ç»„æ ¼å¼æ•°æ®</p>
        
        <div class="test-section">
            <h3>æµ‹è¯•1: åˆ›å»ºæ—§æ ¼å¼æµ‹è¯•æ•°æ®</h3>
            <button onclick="createOldFormatData()">åˆ›å»ºæ—§æ ¼å¼æ•°æ®</button>
            <button onclick="createMixedFormatData()">åˆ›å»ºæ··åˆæ ¼å¼æ•°æ®</button>
            <div id="test1-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•2: æ ‡è®°æœªå®ŒæˆåŠŸèƒ½å…¼å®¹æ€§</h3>
            <button onclick="testMarkIncompleteCompatibility()">æµ‹è¯•æ ‡è®°æœªå®Œæˆ</button>
            <div id="test2-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•3: ç¼–è¾‘åŠŸèƒ½å…¼å®¹æ€§</h3>
            <button onclick="testEditCompatibility()">æµ‹è¯•ç¼–è¾‘åŠŸèƒ½</button>
            <div id="test3-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•4: åˆ é™¤åŠŸèƒ½å…¼å®¹æ€§</h3>
            <button onclick="testDeleteCompatibility()">æµ‹è¯•åˆ é™¤åŠŸèƒ½</button>
            <div id="test4-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•5: å®ŒæˆçŠ¶æ€åˆ‡æ¢å…¼å®¹æ€§</h3>
            <button onclick="testCompleteToggleCompatibility()">æµ‹è¯•å®ŒæˆçŠ¶æ€åˆ‡æ¢</button>
            <div id="test5-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•6: æ•°æ®ç»“æ„éªŒè¯</h3>
            <button onclick="validateAllDataStructures()">å…¨é¢éªŒè¯æ•°æ®ç»“æ„</button>
            <div id="test6-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•7: æ¸…ç†æµ‹è¯•æ•°æ®</h3>
            <button onclick="clearAllTestData()">æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®</button>
            <div id="test7-result" class="result"></div>
        </div>
    </div>

    <script>
        // åˆ›å»ºæ—§æ ¼å¼æ•°æ®ï¼ˆæ•°ç»„æ ¼å¼ï¼‰
        function createOldFormatData() {
            const oldFormatData = {
                "2026-02-10": [
                    {
                        id: 1,
                        title: "æ—§æ ¼å¼è®¡åˆ’1",
                        description: "è¿™æ˜¯æ—§æ ¼å¼çš„æµ‹è¯•è®¡åˆ’",
                        startTime: "20:00",
                        endTime: "21:00",
                        completed: false,
                        reflection: "",
                        incompleteReason: "",
                        date: "2026-02-10"
                    },
                    {
                        id: 2,
                        title: "æ—§æ ¼å¼è®¡åˆ’2",
                        description: "ç¬¬äºŒä¸ªæ—§æ ¼å¼è®¡åˆ’",
                        startTime: "21:00",
                        endTime: "22:00",
                        completed: true,
                        reflection: "å·²å®Œæˆçš„æ—§æ ¼å¼è®¡åˆ’",
                        incompleteReason: "",
                        date: "2026-02-10"
                    }
                ]
            };
            
            localStorage.setItem('studyPlans', JSON.stringify(oldFormatData));
            document.getElementById('test1-result').innerHTML = 
                '<div class="success">âœ… æ—§æ ¼å¼æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸï¼<br>' +
                'æ ¼å¼ç±»å‹: æ•°ç»„æ ¼å¼ï¼ˆæ—§ç‰ˆï¼‰<br>' +
                'è®¡åˆ’æ•°é‡: 2ä¸ª</div>';
        }
        
        // åˆ›å»ºæ··åˆæ ¼å¼æ•°æ®
        function createMixedFormatData() {
            const mixedFormatData = {
                "2026-02-10": [
                    {
                        id: 1,
                        title: "æ··åˆæ ¼å¼è®¡åˆ’1",
                        description: "æ—§æ ¼å¼è®¡åˆ’",
                        startTime: "20:00",
                        endTime: "21:00",
                        completed: false,
                        reflection: "",
                        incompleteReason: "",
                        date: "2026-02-10"
                    }
                ],
                "2026-02-11": {
                    plans: [
                        {
                            id: 3,
                            title: "æ··åˆæ ¼å¼è®¡åˆ’2",
                            description: "æ–°æ ¼å¼è®¡åˆ’",
                            startTime: "20:00",
                            endTime: "21:00",
                            completed: false,
                            reflection: "",
                            incompleteReason: "",
                            date: "2026-02-11"
                        }
                    ],
                    mood: {
                        score: 5,
                        thought: "ä»Šå¤©å¿ƒæƒ…ä¸é”™",
                        dream: "åšäº†ä¸ªå¥½æ¢¦"
                    }
                }
            };
            
            localStorage.setItem('studyPlans', JSON.stringify(mixedFormatData));
            document.getElementById('test1-result').innerHTML = 
                '<div class="warning">âš ï¸ æ··åˆæ ¼å¼æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸï¼<br>' +
                'åŒ…å«æ—§æ ¼å¼(2026-02-10)å’Œæ–°æ ¼å¼(2026-02-11)<br>' +
                'æ€»è®¡åˆ’æ•°é‡: 2ä¸ª</div>';
        }
        
        // æµ‹è¯•æ ‡è®°æœªå®ŒæˆåŠŸèƒ½å…¼å®¹æ€§
        function testMarkIncompleteCompatibility() {
            try {
                const allPlans = JSON.parse(localStorage.getItem('studyPlans') || '{}');
                let successCount = 0;
                let totalCount = 0;
                
                for (const date in allPlans) {
                    totalCount++;
                    const planId = 1; // æµ‹è¯•ç¬¬ä¸€ä¸ªè®¡åˆ’
                    
                    if (allPlans[date]) {
                        // å…¼å®¹æ€§å¤„ç†ï¼šæ­£ç¡®è·å–è®¡åˆ’æ•°ç»„
                        let plansArray;
                        if (Array.isArray(allPlans[date])) {
                            plansArray = allPlans[date];
                        } else {
                            plansArray = allPlans[date].plans || [];
                        }
                        
                        // æŸ¥æ‰¾è¦æ ‡è®°çš„è®¡åˆ’
                        const planIndex = plansArray.findIndex(p => p.id === planId);
                        if (planIndex !== -1) {
                            const plan = plansArray[planIndex];
                            
                            // æ ‡è®°å½“å‰è®¡åˆ’ä¸ºæœªå®Œæˆ
                            plan.completed = false;
                            plan.incompleteReason = "å…¼å®¹æ€§æµ‹è¯•åŸå› ";
                            plan.reflection = '';
                            
                            successCount++;
                        }
                    }
                }
                
                localStorage.setItem('studyPlans', JSON.stringify(allPlans));
                
                if (totalCount > 0) {
                    document.getElementById('test2-result').innerHTML = 
                        `<div class="success">âœ… æ ‡è®°æœªå®Œæˆå…¼å®¹æ€§æµ‹è¯•é€šè¿‡ï¼<br>` +
                        `æˆåŠŸå¤„ç† ${successCount}/${totalCount} ä¸ªæ—¥æœŸçš„æ•°æ®<br>` +
                        `æœªå®ŒæˆåŸå› å·²æ­£ç¡®è®¾ç½®</div>`;
                } else {
                    document.getElementById('test2-result').innerHTML = 
                        '<div class="error">âŒ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•æ•°æ®ï¼</div>';
                }
            } catch (error) {
                document.getElementById('test2-result').innerHTML = 
                    `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•ç¼–è¾‘åŠŸèƒ½å…¼å®¹æ€§
        function testEditCompatibility() {
            try {
                const allPlans = JSON.parse(localStorage.getItem('studyPlans') || '{}');
                let successCount = 0;
                let totalCount = 0;
                
                for (const date in allPlans) {
                    totalCount++;
                    const planId = 1; // æµ‹è¯•ç¬¬ä¸€ä¸ªè®¡åˆ’
                    
                    if (allPlans[date]) {
                        // å…¼å®¹æ€§å¤„ç†ï¼šæ­£ç¡®è·å–è®¡åˆ’æ•°ç»„
                        let plansArray;
                        if (Array.isArray(allPlans[date])) {
                            plansArray = allPlans[date];
                        } else {
                            plansArray = allPlans[date].plans || [];
                        }
                        
                        // æŸ¥æ‰¾è¦ç¼–è¾‘çš„è®¡åˆ’
                        const plan = plansArray.find(p => p.id === planId);
                        if (plan) {
                            // æ¨¡æ‹Ÿç¼–è¾‘æ“ä½œ
                            plan.title = plan.title + " [å·²ç¼–è¾‘]";
                            plan.description = plan.description + " - ç¼–è¾‘æµ‹è¯•";
                            successCount++;
                        }
                    }
                }
                
                localStorage.setItem('studyPlans', JSON.stringify(allPlans));
                
                if (totalCount > 0) {
                    document.getElementById('test3-result').innerHTML = 
                        `<div class="success">âœ… ç¼–è¾‘åŠŸèƒ½å…¼å®¹æ€§æµ‹è¯•é€šè¿‡ï¼<br>` +
                        `æˆåŠŸç¼–è¾‘ ${successCount}/${totalCount} ä¸ªæ—¥æœŸçš„æ•°æ®<br>` +
                        `è®¡åˆ’æ ‡é¢˜å’Œæè¿°å·²æ›´æ–°</div>`;
                } else {
                    document.getElementById('test3-result').innerHTML = 
                        '<div class="error">âŒ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•æ•°æ®ï¼</div>';
                }
            } catch (error) {
                document.getElementById('test3-result').innerHTML = 
                    `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•åˆ é™¤åŠŸèƒ½å…¼å®¹æ€§
        function testDeleteCompatibility() {
            try {
                const allPlans = JSON.parse(localStorage.getItem('studyPlans') || '{}');
                let successCount = 0;
                let totalCount = 0;
                
                for (const date in allPlans) {
                    totalCount++;
                    const planId = 2; // å°è¯•åˆ é™¤ç¬¬äºŒä¸ªè®¡åˆ’
                    
                    if (allPlans[date]) {
                        // å…¼å®¹æ€§å¤„ç†ï¼šæ­£ç¡®å¤„ç†ä¸åŒæ•°æ®æ ¼å¼
                        if (Array.isArray(allPlans[date])) {
                            // æ—§æ ¼å¼ï¼šç›´æ¥è¿‡æ»¤æ•°ç»„
                            const originalLength = allPlans[date].length;
                            allPlans[date] = allPlans[date].filter(p => p.id !== planId);
                            if (allPlans[date].length < originalLength) {
                                successCount++;
                            }
                        } else {
                            // æ–°æ ¼å¼ï¼šè¿‡æ»¤plansæ•°ç»„
                            const originalLength = allPlans[date].plans.length;
                            allPlans[date].plans = allPlans[date].plans.filter(p => p.id !== planId);
                            if (allPlans[date].plans.length < originalLength) {
                                successCount++;
                            }
                        }
                    }
                }
                
                localStorage.setItem('studyPlans', JSON.stringify(allPlans));
                
                if (totalCount > 0) {
                    document.getElementById('test4-result').innerHTML = 
                        `<div class="success">âœ… åˆ é™¤åŠŸèƒ½å…¼å®¹æ€§æµ‹è¯•é€šè¿‡ï¼<br>` +
                        `æˆåŠŸåˆ é™¤ ${successCount}/${totalCount} ä¸ªæ—¥æœŸä¸­çš„è®¡åˆ’<br>` +
                        `æ•°æ®ç»“æ„ä¿æŒå®Œæ•´</div>`;
                } else {
                    document.getElementById('test4-result').innerHTML = 
                        '<div class="error">âŒ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•æ•°æ®ï¼</div>';
                }
            } catch (error) {
                document.getElementById('test4-result').innerHTML = 
                    `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•å®ŒæˆçŠ¶æ€åˆ‡æ¢å…¼å®¹æ€§
        function testCompleteToggleCompatibility() {
            try {
                const allPlans = JSON.parse(localStorage.getItem('studyPlans') || '{}');
                let successCount = 0;
                let totalCount = 0;
                
                for (const date in allPlans) {
                    totalCount++;
                    
                    if (allPlans[date]) {
                        // å…¼å®¹æ€§å¤„ç†ï¼šæ­£ç¡®è·å–è®¡åˆ’æ•°ç»„
                        let plansArray;
                        if (Array.isArray(allPlans[date])) {
                            plansArray = allPlans[date];
                        } else {
                            plansArray = allPlans[date].plans || [];
                        }
                        
                        // åˆ‡æ¢æ‰€æœ‰è®¡åˆ’çš„å®ŒæˆçŠ¶æ€
                        plansArray.forEach(plan => {
                            plan.completed = !plan.completed;
                            if (plan.completed) {
                                plan.reflection = "å…¼å®¹æ€§æµ‹è¯•å®Œæˆ";
                                plan.incompleteReason = "";
                            }
                            successCount++;
                        });
                    }
                }
                
                localStorage.setItem('studyPlans', JSON.stringify(allPlans));
                
                if (totalCount > 0) {
                    document.getElementById('test5-result').innerHTML = 
                        `<div class="success">âœ… å®ŒæˆçŠ¶æ€åˆ‡æ¢å…¼å®¹æ€§æµ‹è¯•é€šè¿‡ï¼<br>` +
                        `æˆåŠŸåˆ‡æ¢ ${successCount} ä¸ªè®¡åˆ’çš„çŠ¶æ€<br>` +
                        `å·²å®Œæˆè®¡åˆ’æ·»åŠ äº†åæ€å†…å®¹</div>`;
                } else {
                    document.getElementById('test5-result').innerHTML = 
                        '<div class="error">âŒ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•æ•°æ®ï¼</div>';
                }
            } catch (error) {
                document.getElementById('test5-result').innerHTML = 
                    `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`;
            }
        }
        
        // å…¨é¢éªŒè¯æ•°æ®ç»“æ„
        function validateAllDataStructures() {
            try {
                const allPlans = JSON.parse(localStorage.getItem('studyPlans') || '{}');
                let html = '<div class="info"><strong>æ•°æ®ç»“æ„éªŒè¯ç»“æœ:</strong><br><br>';
                
                let oldFormatCount = 0;
                let newFormatCount = 0;
                let totalPlans = 0;
                
                for (const date in allPlans) {
                    html += `ğŸ“… æ—¥æœŸ: ${date}<br>`;
                    
                    if (Array.isArray(allPlans[date])) {
                        // æ—§æ ¼å¼ï¼ˆæ•°ç»„ï¼‰
                        oldFormatCount++;
                        const planCount = allPlans[date].length;
                        totalPlans += planCount;
                        html += `ğŸ“Š æ ¼å¼: æ—§æ ¼å¼ï¼ˆæ•°ç»„ï¼‰<br>`;
                        html += `ğŸ“‹ è®¡åˆ’æ•°é‡: ${planCount}<br>`;
                        
                        // éªŒè¯æ¯ä¸ªè®¡åˆ’çš„å¿…è¦å­—æ®µ
                        allPlans[date].forEach((plan, index) => {
                            html += `&nbsp;&nbsp;ğŸ“ è®¡åˆ’${index + 1}: ${plan.title}<br>`;
                            html += `&nbsp;&nbsp;&nbsp;&nbsp;çŠ¶æ€: ${plan.completed ? 'âœ…å·²å®Œæˆ' : (plan.incompleteReason ? `âŒæœªå®Œæˆ(${plan.incompleteReason})` : 'â³æœªå¼€å§‹')}<br>`;
                            
                            // æ£€æŸ¥å¿…è¦å­—æ®µ
                            const requiredFields = ['id', 'title', 'startTime', 'endTime', 'date'];
                            const missingFields = requiredFields.filter(field => plan[field] === undefined);
                            if (missingFields.length > 0) {
                                html += `&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: red;">âš ï¸ ç¼ºå°‘å­—æ®µ: ${missingFields.join(', ')}</span><br>`;
                            }
                        });
                    } else {
                        // æ–°æ ¼å¼ï¼ˆå¯¹è±¡ï¼‰
                        newFormatCount++;
                        const planCount = (allPlans[date].plans || []).length;
                        const moodExists = Object.keys(allPlans[date].mood || {}).length > 0;
                        totalPlans += planCount;
                        html += `ğŸ“Š æ ¼å¼: æ–°æ ¼å¼ï¼ˆå¯¹è±¡ï¼‰<br>`;
                        html += `ğŸ“‹ è®¡åˆ’æ•°é‡: ${planCount}<br>`;
                        html += `ğŸ’­ éšç¬”æ•°æ®: ${moodExists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}<br>`;
                        
                        // éªŒè¯è®¡åˆ’
                        (allPlans[date].plans || []).forEach((plan, index) => {
                            html += `&nbsp;&nbsp;ğŸ“ è®¡åˆ’${index + 1}: ${plan.title}<br>`;
                            html += `&nbsp;&nbsp;&nbsp;&nbsp;çŠ¶æ€: ${plan.completed ? 'âœ…å·²å®Œæˆ' : (plan.incompleteReason ? `âŒæœªå®Œæˆ(${plan.incompleteReason})` : 'â³æœªå¼€å§‹')}<br>`;
                        });
                        
                        // éªŒè¯éšç¬”æ•°æ®ç»“æ„
                        if (moodExists) {
                            const moodFields = Object.keys(allPlans[date].mood);
                            html += `&nbsp;&nbsp;ğŸ’­ éšç¬”å­—æ®µ: ${moodFields.join(', ')}<br>`;
                        }
                    }
                    html += '<br>';
                }
                
                html += `<hr><strong>ç»Ÿè®¡æ‘˜è¦:</strong><br>`;
                html += `ğŸ“ æ€»æ—¥æœŸæ•°: ${Object.keys(allPlans).length}<br>`;
                html += `ğŸ“Š æ—§æ ¼å¼æ—¥æœŸ: ${oldFormatCount}<br>`;
                html += `ğŸ“Š æ–°æ ¼å¼æ—¥æœŸ: ${newFormatCount}<br>`;
                html += `ğŸ“‹ æ€»è®¡åˆ’æ•°: ${totalPlans}<br>`;
                html += '</div>';
                
                document.getElementById('test6-result').innerHTML = html;
            } catch (error) {
                document.getElementById('test6-result').innerHTML = 
                    `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`;
            }
        }
        
        // æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®
        function clearAllTestData() {
            localStorage.removeItem('studyPlans');
            document.getElementById('test7-result').innerHTML = 
                '<div class="success">âœ… æ‰€æœ‰æµ‹è¯•æ•°æ®å·²æ¸…ç†ï¼</div>';
            
            // æ¸…ç©ºå…¶ä»–ç»“æœæ˜¾ç¤º
            document.getElementById('test1-result').innerHTML = '';
            document.getElementById('test2-result').innerHTML = '';
            document.getElementById('test3-result').innerHTML = '';
            document.getElementById('test4-result').innerHTML = '';
            document.getElementById('test5-result').innerHTML = '';
            document.getElementById('test6-result').innerHTML = '';
        }
    </script>
</body>
</html>